---
- name: Disabling Swap on all nodes
  shell: /sbin/swapoff -a
  with_inventory_hostnames:
    - nodes 

- name: Commenting Swap entries in /etc/fstab
  replace:
    path: /etc/fstab
    regexp: '(.*swap*)'
    replace: '#\1'
  with_inventory_hostnames: 
    - nodes

- name: Load kernel modules for RKE
  modprobe:
    name: "{{ item }}"
    state: present
  loop: "{{ kernel_modules }}"

- name: Modify sysctl entries
  sysctl:
    name: '{{ item.key }}'
    value: '{{ item.value }}'
    sysctl_set: yes
    state: present
  loop:
    - {key: net.bridge.bridge-nf-call-ip6tables, value: 1}
    - {key: net.bridge.bridge-nf-call-iptables,  value: 1}
    - {key: net.ipv4.ip_forward,  value: 1}

- name: Disable PermitTunnel and AllowTcpForwarding
  lineinfile:
    dest=/etc/ssh/sshd_config
    state=present
    regexp=^{{ item.key }}
    line="{{ item.key }} {{ item.value }}"
    insertafter=EOF
  loop:
    - { key: 'PermitTunnel', value: 'no' }
    - { key: 'AllowTcpForwarding', value: 'yes' }
  notify: restart sshd

- name: install rancher docker 
  shell: curl https://releases.rancher.com/install-docker/19.03.sh | sh 

- name: install epel repo
  yum: name=epel-release state=present 

- name: add kubernetes repo
  yum_repository:
    name: kubernetes
    description: Kubernetes repo
    baseurl: https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
    gpgcheck: no
    sslverify: no
    enabled: true

- name: update 
  yum: name=* state=latest

- name: install docker and other dependencies  
  yum: name={{ item }} state=present
  loop:
   - "{{ packages }}"

- name: Start docker service
  shell: systemctl daemon-reload && systemctl enable docker && systemctl restart docker

- name: adding existing user "{{ ansible_user }}" to group docker 
  user:
    name: "{{ ansible_user }}"
    groups: docker
    append: yes

- name: Starting and Enabling the required services
  service:
   name: "{{ item }}"
   state: started
   enabled: yes
  loop: "{{ services }}"

- name: open ports noedes
  firewalld:
    port: "{{item}}"
    permanent: true
    state: enabled
  loop:
    - 6443/tcp
    - 5443/tcp
    - 2379-2380/tcp
    - 10250/tcp
    - 10251/tcp
    - 10252/tcp
    - 10053/tcp
    - 10053/udp
    - 10255/tcp
    - 30000-32767/tcp
    - 8082/tcp
    - 8472/udp
    - 8285/udp
    - 9898/tcp
    - 9100/tcp
    - 443/tcp
    - 53/tcp
    - 53/udp
    - 80/tcp
    - 443/tcp
    - 4194/tcp
    - 10254/tcp

- name: Enable IP masquerading
  shell: "firewall-cmd --permanent --zone={{ network_zone }} --add-masquerade"

- name: reload firewalld
  shell: firewall-cmd --reload

- name: preload docker images 
  shell: docker pull "{{ item }}" 
  loop: 
    rancher/coreos-etcd:v3.4.3-rancher1
    rancher/rke-tools:v0.1.66
    rancher/k8s-dns-kube-dns:1.15.0
    rancher/k8s-dns-dnsmasq-nanny:1.15.0
    rancher/k8s-dns-sidecar:1.15.0
    rancher/cluster-proportional-autoscaler:1.7.1
    rancher/coredns-coredns:1.6.5
    rancher/k8s-dns-node-cache:1.15.7
    rancher/hyperkube:v1.17.14-rancher1
    rancher/coreos-flannel:v0.12.0
    rancher/flannel-cni:v0.3.0-rancher6
    rancher/calico-node:v3.13.4
    rancher/calico-cni:v3.13.4
    rancher/calico-kube-controllers:v3.13.4
    rancher/calico-ctl:v3.13.4
    rancher/calico-pod2daemon-flexvol:v3.13.4
    weaveworks/weave-kube:2.6.4
    weaveworks/weave-npc:2.6.4
    rancher/pause:3.1
    rancher/nginx-ingress-controller:nginx-0.35.0-rancher2
    rancher/nginx-ingress-controller-defaultbackend:1.5-rancher1
    rancher/metrics-server:v0.3.6

- name: Install a list of packages (suitable replacement for 2.11 loop deprecation warning)
  yum:
    name:
      - htop  
      - nload 
      - git
      - qemu-guest-agent 
    state: present
